@using SupporterPortal.Application.Models.SiteSearch
@using SupporterPortal.Application.Services
@using Umbraco.Cms.Core.Models.Blocks
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<BlockGridItem>
@inject ISiteSearchService siteSearchService

@{
    string blockTitle = Model.Content.Value<string>("headline") ?? "Search Results";
    string searchTerm = Model.Content.Value<string>("searchTerm") ?? "";
    string[] contentTypes = Model.Content.Value<string[]>("contentTypes") ?? Array.Empty<string>();
    int pageSize = Model.Content.Value<int>("pageSize") > 0 ? Model.Content.Value<int>("pageSize") : 6;

    int page = 1;
    if (int.TryParse(Context.Request.Query["page"], out var p)) page = p;

    SiteSearchRequest request = new()
    {
        SearchTerm = searchTerm,
        ContentTypeAliases = contentTypes,
        Page = page,
        PageSize = pageSize
    };

    SiteSearchResponse results = siteSearchService.GetPages(request);
}

<div class="site-search-block">
    <h2>@blockTitle</h2>

    @if (!results.Results.Any())
    {
        <p>No results found.</p>
    }
    else
    {
        <div class="row g-3">
            @foreach (var item in results.Results)
            {
                <div class="col-md-4">
                    <div class="card h-100">
                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                        {
                            <img src="@item.ImageUrl" class="card-img-top" alt="@item.Title" />
                        }
                        <div class="card-body">
                            <h5 class="card-title">@item.Title</h5>
                            <p class="card-text">@item.Summary</p>
                            <a href="@item.Url" class="btn btn-primary">Read more</a>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (results.TotalCount > results.PageSize)
        {
            var totalPages = (int)Math.Ceiling((double)results.TotalCount / results.PageSize);
            <nav aria-label="Search results pagination" class="mt-3">
                <ul class="pagination">
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        <li class="page-item @(i == results.Page ? "active" : "")">
                            <a class="page-link" href="?page=@i">@i</a>
                        </li>
                    }
                </ul>
            </nav>
        }
    }
</div>

